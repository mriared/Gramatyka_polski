<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Polski - ƒÜwiczenia z Gramatyki</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --cream: #FFF8F0;
            --deep-red: #8B2635;
            --warm-red: #C1403D;
            --soft-pink: #FFE8E8;
            --charcoal: #2C2C2C;
            --light-gray: #F5F5F5;
            --medium-gray: #CCCCCC;
            --success: #2D7D5E;
            --error: #C1403D;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #FFF5E6 100%);
            min-height: 100vh;
            color: var(--charcoal);
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .app-container {
                padding: 2rem;
            }
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            -webkit-animation: fadeInDown 0.8s ease-out;
            animation: fadeInDown 0.8s ease-out;
        }

        @media (min-width: 768px) {
            .header {
                margin-bottom: 3rem;
            }
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--deep-red);
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        @media (min-width: 768px) {
            .logo {
                font-size: 3.5rem;
            }
        }

        .tagline {
            font-size: 0.85rem;
            color: var(--warm-red);
            font-weight: 500;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        @media (min-width: 768px) {
            .tagline {
                font-size: 1rem;
                letter-spacing: 2px;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(139, 38, 53, 0.08);
            margin-bottom: 1.5rem;
            -webkit-animation: fadeInUp 0.6s ease-out;
            animation: fadeInUp 0.6s ease-out;
            -webkit-animation-fill-mode: both;
            animation-fill-mode: both;
        }

        @media (min-width: 768px) {
            .card {
                padding: 2.5rem;
                margin-bottom: 2rem;
            }
        }

        .card:nth-child(2) { 
            -webkit-animation-delay: 0.1s;
            animation-delay: 0.1s; 
        }
        .card:nth-child(3) { 
            -webkit-animation-delay: 0.2s;
            animation-delay: 0.2s; 
        }

        h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            color: var(--deep-red);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            h2 {
                font-size: 2rem;
            }
        }

        h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.25rem;
            color: var(--charcoal);
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            h3 {
                font-size: 1.5rem;
            }
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--charcoal);
            font-size: 0.95rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px; /* Prevents zoom on iOS */
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            background: var(--light-gray);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--warm-red);
            background: white;
            -webkit-transform: translateY(-2px);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 64, 61, 0.15);
        }

        /* Fix iOS zoom on input focus */
        @media screen and (max-width: 767px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            padding: 0.875rem 1.5rem;
            background: var(--deep-red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            button {
                padding: 0.875rem 2rem;
                font-size: 1rem;
            }
        }

        button:hover {
            background: var(--warm-red);
            -webkit-transform: translateY(-2px);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(193, 64, 61, 0.3);
        }

        button:active {
            -webkit-transform: translateY(0);
            transform: translateY(0);
        }

        button.secondary {
            background: transparent;
            color: var(--deep-red);
            border: 2px solid var(--deep-red);
        }

        button.secondary:hover {
            background: var(--soft-pink);
            border-color: var(--warm-red);
        }

        .exercise-display {
            background: var(--soft-pink);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--warm-red);
        }

        @media (min-width: 768px) {
            .exercise-display {
                padding: 2rem;
            }
        }

        .exercise-instruction {
            font-size: 0.9rem;
            color: var(--deep-red);
            margin-bottom: 1.5rem;
            font-weight: 500;
            line-height: 1.6;
        }

        .exercise-sentence {
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            color: var(--charcoal);
            margin-bottom: 1rem;
            line-height: 1.8;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .exercise-sentence {
                font-size: 1.4rem;
            }
        }

        .exercise-hint {
            color: var(--warm-red);
            font-weight: 600;
        }

        .answer-input {
            background: white !important;
            border: 3px solid var(--deep-red) !important;
            font-size: 1.1rem !important;
            padding: 1rem !important;
            text-align: center;
        }

        @media (min-width: 768px) {
            .answer-input {
                font-size: 1.2rem !important;
            }
        }

        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 500;
            -webkit-animation: slideIn 0.4s ease-out;
            animation: slideIn 0.4s ease-out;
        }

        .feedback.correct {
            background: #E8F5E9;
            color: var(--success);
            border: 2px solid var(--success);
        }

        .feedback.incorrect {
            background: #FFEBEE;
            color: var(--error);
            border: 2px solid var(--error);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--deep-red), var(--warm-red));
            -webkit-transition: width 0.5s ease;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--soft-pink);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-family: 'Crimson Pro', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-red);
            display: block;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--charcoal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        @media (min-width: 768px) {
            .button-group {
                flex-direction: row;
                gap: 1rem;
            }
        }

        .button-group button {
            flex: 1;
        }

        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .category-badge {
            padding: 0.5rem 1rem;
            background: var(--light-gray);
            color: var(--charcoal);
            border: 2px solid var(--medium-gray);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .category-badge:hover,
        .category-badge.active {
            background: var(--deep-red);
            color: white;
            border-color: var(--deep-red);
            -webkit-transform: scale(1.05);
            transform: scale(1.05);
        }

        .import-section {
            border: 2px dashed var(--medium-gray);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 1.5rem;
            background: var(--light-gray);
        }

        @media (min-width: 768px) {
            .import-section {
                padding: 2rem;
            }
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 1rem 0;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            background: white;
            color: var(--deep-red);
            border: 2px solid var(--deep-red);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 768px) {
            .file-input-label {
                padding: 0.875rem 2rem;
            }
        }

        .file-input-label:hover {
            background: var(--soft-pink);
        }

        #importStatus {
            display: none;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Animations with webkit prefixes */
        @-webkit-keyframes fadeInDown {
            from {
                opacity: 0;
                -webkit-transform: translateY(-20px);
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                -webkit-transform: translateY(-20px);
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }

        @-webkit-keyframes fadeInUp {
            from {
                opacity: 0;
                -webkit-transform: translateY(20px);
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                -webkit-transform: translateY(20px);
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateY(0);
                transform: translateY(0);
            }
        }

        @-webkit-keyframes slideIn {
            from {
                opacity: 0;
                -webkit-transform: translateX(-10px);
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                -webkit-transform: translateX(-10px);
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                -webkit-transform: translateX(0);
                transform: translateX(0);
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function PolishGrammarApp() {
            const [exercises, setExercises] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswer, setUserAnswer] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [stats, setStats] = useState({
                correct: 0,
                incorrect: 0,
                total: 0
            });
            const [selectedCategories, setSelectedCategories] = useState([]);
            const [showAllExercises, setShowAllExercises] = useState(false);

            useEffect(() => {
                window.setAppExercises = setExercises;
                window.getAppExercises = () => exercises;
                
                return () => {
                    window.setAppExercises = null;
                    window.getAppExercises = null;
                };
            }, [exercises]);

            // Helper function to replace newlines with spaces
            const replaceNewlines = (text) => {
                if (!text) return '';
                return text.replace(/\\n|\n/g, ' ').replace(/\s+/g, ' ').trim();
            };

            const allCategories = [...new Set(
                exercises.flatMap(ex => 
                    Array.isArray(ex.category) ? ex.category : [ex.category]
                )
            )].filter(Boolean);

            const filteredExercises = selectedCategories.length > 0
                ? exercises.filter(ex => {
                    const exCategories = Array.isArray(ex.category) ? ex.category : [ex.category];
                    return selectedCategories.some(cat => exCategories.includes(cat));
                })
                : exercises;

            const currentExercise = filteredExercises[currentIndex];

            const handleCategoryToggle = (category) => {
                setSelectedCategories(prev =>
                    prev.includes(category)
                        ? prev.filter(c => c !== category)
                        : [...prev, category]
                );
                setCurrentIndex(0);
                setFeedback(null);
                setUserAnswer('');
            };

            const normalizeText = (text) => {
                return text
                    .toLowerCase()
                    .trim()
                    .replace(/\s+/g, ' ')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
            };

            const checkAnswer = () => {
                if (!currentExercise || !userAnswer.trim()) return;

                const correctAnswers = currentExercise.answer
                    .split(';')
                    .map(ans => normalizeText(ans));
                
                const userAnswerNormalized = normalizeText(userAnswer);
                const isCorrect = correctAnswers.includes(userAnswerNormalized);

                setFeedback({
                    correct: isCorrect,
                    message: isCorrect 
                        ? '‚úì ≈öwietnie! Poprawna odpowied≈∫!' 
                        : `‚úó Niepoprawnie. Poprawna odpowied≈∫: ${currentExercise.answer}`,
                    rule: currentExercise.rule
                });

                setStats(prev => ({
                    correct: prev.correct + (isCorrect ? 1 : 0),
                    incorrect: prev.incorrect + (isCorrect ? 0 : 1),
                    total: prev.total + 1
                }));
            };

            const nextExercise = () => {
                if (currentIndex < filteredExercises.length - 1) {
                    setCurrentIndex(currentIndex + 1);
                    setUserAnswer('');
                    setFeedback(null);
                } else {
                    alert('Uko≈Ñczy≈Çe≈õ wszystkie ƒáwiczenia! üéâ');
                }
            };

            const resetExercise = () => {
                setUserAnswer('');
                setFeedback(null);
            };

            const shuffleExercises = () => {
                const shuffled = [...filteredExercises].sort(() => Math.random() - 0.5);
                // Update the main exercises array with shuffled order
                const otherExercises = exercises.filter(ex => !filteredExercises.includes(ex));
                setExercises([...shuffled, ...otherExercises]);
                setCurrentIndex(0);
                setUserAnswer('');
                setFeedback(null);
            };

            const addExercise = (exerciseData) => {
                const newExercise = {
                    id: exercises.length + 1,
                    ...exerciseData
                };
                setExercises([...exercises, newExercise]);
            };

            const deleteExercise = (id) => {
                if (window.confirm('Czy na pewno chcesz usunƒÖƒá to ƒáwiczenie?')) {
                    setExercises(exercises.filter(ex => ex.id !== id));
                    if (currentIndex >= exercises.length - 1) {
                        setCurrentIndex(Math.max(0, exercises.length - 2));
                    }
                }
            };

            const progress = filteredExercises.length > 0
                ? ((currentIndex + 1) / filteredExercises.length) * 100
                : 0;

            return (
                <div className="app-container">
                    <div className="header">
                        <h1 className="logo">Polski</h1>
                        <p className="tagline">ƒÜwiczenia z Gramatyki</p>
                    </div>

                    <div className="card">
                        <h2>üì• Importuj ƒÜwiczenia</h2>
                        <div className="import-section">
                            <p style={{marginBottom: '1rem', color: 'var(--charcoal)'}}>
                                Wybierz plik Excel z ƒáwiczeniami lub pobierz szablon
                            </p>
                            <div className="file-input-wrapper">
                                <input 
                                    type="file" 
                                    id="excelFileInput" 
                                    accept=".xlsx,.xls"
                                    className="file-input"
                                    onChange={() => window.loadExcelFileFromDOM()}
                                />
                                <label htmlFor="excelFileInput" className="file-input-label">
                                    üìÇ Wybierz plik Excel
                                </label>
                            </div>
                            <div className="button-group">
                                <button className="secondary" onClick={() => window.downloadExcelTemplate()}>
                                    ‚¨áÔ∏è Pobierz szablon Excel
                                </button>
                            </div>
                            <div id="importStatus"></div>
                        </div>
                    </div>

                    {exercises.length > 0 && (
                        <>
                            {allCategories.length > 0 && (
                                <div className="card">
                                    <h3>üè∑Ô∏è Filtry kategorii</h3>
                                    <div className="category-filter">
                                        {allCategories.map(cat => (
                                            <div
                                                key={cat}
                                                className={`category-badge ${selectedCategories.includes(cat) ? 'active' : ''}`}
                                                onClick={() => handleCategoryToggle(cat)}
                                            >
                                                {cat}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="card">
                                <h2>üìö ƒÜwiczenie {currentIndex + 1} / {filteredExercises.length}</h2>
                                <div className="progress-bar">
                                    <div className="progress-fill" style={{width: `${progress}%`}}></div>
                                </div>
                                <div style={{marginBottom: '1.5rem', textAlign: 'center'}}>
                                    <button 
                                        className="secondary" 
                                        onClick={shuffleExercises}
                                        style={{padding: '0.5rem 1.5rem', fontSize: '0.9rem'}}
                                    >
                                        üîÄ Wymieszaj ƒáwiczenia
                                    </button>
                                </div>

                                {currentExercise && (
                                    <>
                                        <div className="exercise-display">
                                            <p className="exercise-instruction">
                                                {currentExercise.instruction}
                                            </p>
                                            <p className="exercise-sentence">
                                                {currentExercise.sentence}
                                            </p>
                                            {currentExercise.hint && (
                                                <p className="exercise-hint">
                                                    üí° {currentExercise.hint}
                                                </p>
                                            )}
                                        </div>

                                        <div className="input-group">
                                            <label>Twoja odpowied≈∫:</label>
                                            <input
                                                type="text"
                                                className="answer-input"
                                                value={userAnswer}
                                                onChange={(e) => setUserAnswer(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && checkAnswer()}
                                                placeholder="Wpisz odpowied≈∫..."
                                                disabled={feedback !== null}
                                            />
                                        </div>

                                        {feedback && (
                                            <div className={`feedback ${feedback.correct ? 'correct' : 'incorrect'}`}>
                                                <p style={{marginBottom: '0.5rem', fontSize: '1.1rem'}}>
                                                    {feedback.message}
                                                </p>
                                                {feedback.rule && (
                                                    <p style={{fontSize: '0.9rem', lineHeight: '1.6', whiteSpace: 'pre-line'}}>
                                                        üìñ {feedback.rule}
                                                    </p>
                                                )}
                                            </div>
                                        )}

                                        <div className="button-group">
                                            {!feedback ? (
                                                <>
                                                    <button onClick={checkAnswer}>
                                                        ‚úì Sprawd≈∫
                                                    </button>
                                                    <button className="secondary" onClick={resetExercise}>
                                                        ‚Üª Wyczy≈õƒá
                                                    </button>
                                                </>
                                            ) : (
                                                <button onClick={nextExercise}>
                                                    ‚Üí Nastƒôpne ƒáwiczenie
                                                </button>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="card">
                                <h2>üìä Statystyki</h2>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <span className="stat-value">{stats.total}</span>
                                        <span className="stat-label">Razem</span>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{stats.correct}</span>
                                        <span className="stat-label">Poprawne</span>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{stats.incorrect}</span>
                                        <span className="stat-label">B≈Çƒôdne</span>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">
                                            {stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0}%
                                        </span>
                                        <span className="stat-label">Skuteczno≈õƒá</span>
                                    </div>
                                </div>
                            </div>

                            <div className="card">
                                <h2>üìù ZarzƒÖdzaj ƒáwiczeniami</h2>
                                <div className="button-group">
                                    <button className="secondary" onClick={() => setShowAllExercises(!showAllExercises)}>
                                        {showAllExercises ? '‚Üë Ukryj listƒô' : '‚Üì Poka≈º wszystkie'}
                                    </button>
                                    <button onClick={() => window.downloadExcelTemplate()}>
                                        üíæ Eksportuj do Excel
                                    </button>
                                </div>

                                {showAllExercises && (
                                    <div style={{marginTop: '1.5rem'}}>
                                        {exercises.map((ex, idx) => (
                                            <div key={ex.id} style={{
                                                padding: '1rem',
                                                marginBottom: '0.75rem',
                                                background: 'var(--light-gray)',
                                                borderRadius: '8px',
                                                borderLeft: '4px solid var(--warm-red)'
                                            }}>
                                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '0.5rem'}}>
                                                    <div style={{flex: 1, minWidth: '200px'}}>
                                                        <strong>#{idx + 1}</strong> - {ex.sentence.substring(0, 50)}...
                                                        <br/>
                                                        <small style={{color: 'var(--warm-red)'}}>
                                                            {Array.isArray(ex.category) ? ex.category.join(', ') : ex.category}
                                                        </small>
                                                    </div>
                                                    <button 
                                                        className="secondary" 
                                                        style={{padding: '0.5rem 1rem', fontSize: '0.85rem'}}
                                                        onClick={() => deleteExercise(ex.id)}
                                                    >
                                                        üóëÔ∏è Usu≈Ñ
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<PolishGrammarApp />, document.getElementById('root'));
    </script>

    <script>
        function parseCategories(categoryString) {
            if (!categoryString) return [];
            
            if (typeof categoryString === 'string') {
                return categoryString.split(';').map(cat => cat.trim()).filter(Boolean);
            }
            
            return [categoryString];
        }
        
        // Helper function to process rule text - converts literal \n to actual newlines
        function processRuleText(ruleText) {
            if (!ruleText) return '';
            const text = ruleText.toString();
            // Replace literal \n with actual newlines (in case Excel stored it as text)
            return text.replace(/\\n/g, '\n');
        }
        
        window.loadExcelFile = function(setExercises) {
            const fileInput = document.getElementById('excelFileInput');
            
            if (!fileInput.files || !fileInput.files[0]) {
                window.showStatus('Proszƒô wybraƒá plik Excel!', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const sheetNames = Object.keys(workbook.Sheets);
                    if (sheetNames.length === 0) {
                        window.showStatus('Nie znaleziono arkuszy w pliku!', 'error');
                        setExercises([]);
                        return;
                    }
                    const firstSheetName = sheetNames[0];
                    const firstSheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    const newExercises = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length >= 6 && (row[5] && row[5].toString().trim() !== '')) { 
                            newExercises.push({
                                id: parseInt(row[0]) || i, 
                                category: parseCategories(row[1]),
                                instruction: row[2] || '',
                                sentence: row[3] || '',
                                hint: row[4] || '',
                                answer: row[5].toString().trim() || '',
                                rule: processRuleText(row[6])
                            });
                        }
                    }
                    
                    if (newExercises.length === 0) {
                        window.showStatus('Nie znaleziono ƒáwicze≈Ñ w pliku!', 'error');
                        setExercises([]);
                        return;
                    }
                    
                    setExercises(newExercises);
                    
                    window.showStatus(`‚úÖ Wczytano ${newExercises.length} ƒáwicze≈Ñ z Excel!`, 'success');
                    
                } catch (error) {
                    window.showStatus('‚ùå B≈ÇƒÖd podczas wczytywania pliku: ' + error.message, 'error');
                    console.error(error);
                }
            };
            
            reader.onerror = function() {
                window.showStatus('‚ùå B≈ÇƒÖd podczas odczytu pliku!', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        };
        
        window.loadExcelFileFromDOM = function() {
            const setExercises = window.setAppExercises;
            if (setExercises) {
                const fileInput = document.getElementById('excelFileInput');
                
                if (!fileInput.files || !fileInput.files[0]) {
                    window.showStatus('Proszƒô wybraƒá plik Excel!', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        const sheetNames = Object.keys(workbook.Sheets);
                        if (sheetNames.length === 0) {
                            window.showStatus('Nie znaleziono arkuszy w pliku!', 'error');
                            setExercises([]);
                            return;
                        }
                        const firstSheetName = sheetNames[0];
                        const firstSheet = workbook.Sheets[firstSheetName];
                        
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        const newExercises = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 6 && (row[5] && row[5].toString().trim() !== '')) { 
                                newExercises.push({
                                    id: parseInt(row[0]) || i,
                                    category: parseCategories(row[1]),
                                    instruction: row[2] || '',
                                    sentence: row[3] || '',
                                    hint: row[4] || '',
                                    answer: row[5].toString().trim() || '',
                                    rule: processRuleText(row[6])
                                });
                            }
                        }
                        
                        if (newExercises.length === 0) {
                            window.showStatus('Nie znaleziono ƒáwicze≈Ñ w pliku!', 'error');
                            setExercises([]);
                            return;
                        }
                        
                        setExercises(newExercises);
                        
                        window.showStatus(`‚úÖ Wczytano ${newExercises.length} ƒáwicze≈Ñ z Excel!`, 'success');
                        
                    } catch (error) {
                        window.showStatus('‚ùå B≈ÇƒÖd podczas wczytywania pliku: ' + error.message, 'error');
                        console.error(error);
                    }
                };
                
                reader.onerror = function() {
                    window.showStatus('‚ùå B≈ÇƒÖd podczas odczytu pliku!', 'error');
                };
                
                reader.readAsArrayBuffer(file);
            } else {
                window.showStatus('‚ùå B≈ÇƒÖd: Aplikacja nie jest gotowa do ≈Çadowania.', 'error');
            }
        };

        window.showStatus = function(message, type) {
            const statusDiv = document.getElementById('importStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message;
            
            if (type === 'success') {
                statusDiv.style.background = '#E8F5E9';
                statusDiv.style.border = '2px solid #4CAF50';
                statusDiv.style.color = '#2D7D5E';
            } else if (type === 'error') {
                statusDiv.style.background = '#FFEBEE';
                statusDiv.style.border = '2px solid #f44336';
                statusDiv.style.color = '#C1403D';
            }
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        };
        
        window.downloadExcelTemplate = function() {
            const currentExercises = (window.getAppExercises && window.getAppExercises()) || [];

            const wb = XLSX.utils.book_new();
            
            const wsData = [
                ['ID', 'Kategoria', 'Polecenie', 'Przyk≈Çad (zdanie)', 'S≈Çowo (hint)', 'Poprawna odpowied≈∫', 'Zasada gramatyczna']
            ];
            
            if (currentExercises.length > 0) {
                currentExercises.forEach(ex => {
                    wsData.push([
                        ex.id,
                        Array.isArray(ex.category) ? ex.category.join(';') : ex.category,
                        ex.instruction,
                        ex.sentence,
                        ex.hint,
                        ex.answer,
                        ex.rule
                    ]);
                });
            } else {
                wsData.push([
                    1,
                    'Liczba mnoga mƒôskoosobowa; Mianownik',
                    'Proszƒô wpisaƒá rzeczownik i przymiotnik w odpowiedniej formie do zdania.',
                    'Spotka≈Çam wczoraj ____________ na ulicy.',
                    '(m≈Çody re≈ºyser)',
                    'm≈Çodzi re≈ºyserzy; m≈Çodzi re≈ºyserowie',
                    'Rzeczowniki i przymiotniki mƒôskoosobowe w liczbie mnogiej majƒÖ ko≈Ñc√≥wkƒô -i lub -y, a czasami obie sƒÖ poprawne.\nU≈ºywaj Alt+Enter w Excelu, aby dodaƒá nowƒÖ liniƒô wewnƒÖtrz kom√≥rki!'
                ]);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                {wch: 8},
                {wch: 40},
                {wch: 45},
                {wch: 50},
                {wch: 30},
                {wch: 35},
                {wch: 100}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ƒÜwiczenia');
            
            XLSX.writeFile(wb, 'polish-grammar-exercises.xlsx');
        };
    </script>
</body>
</html>